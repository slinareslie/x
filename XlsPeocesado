Sub EmparejarFechasSinConvertir()

    Dim wsDatos As Worksheet, wsParejas As Worksheet
    Dim ultimaFila As Long, i As Long, j As Long
    Dim entradas As Collection, salidas As Collection
    Dim usada() As Boolean
    Dim filaResultado As Long

    Set wsDatos = ThisWorkbook.Sheets("Datos")

    ' Crear o limpiar hoja "Parejas"
    On Error Resume Next
    Application.DisplayAlerts = False
    ThisWorkbook.Sheets("Parejas").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    Set wsParejas = ThisWorkbook.Sheets.Add
    wsParejas.Name = "Parejas"

    wsParejas.Range("A1:D1").Value = Array("Placa", "Fecha Entrada", "Fecha Salida", "Diferencia")

    ' Inicializar colecciones
    Set entradas = New Collection
    Set salidas = New Collection

    ultimaFila = wsDatos.Cells(wsDatos.Rows.Count, "B").End(xlUp).Row

    ' Leer datos como texto, exactamente como est치n visualmente
    For i = 2 To ultimaFila
        Dim tipo As String: tipo = Trim(wsDatos.Cells(i, "B").Value)
        Dim placa As String: placa = Trim(wsDatos.Cells(i, "G").Value)

        If tipo = "01" Then
            entradas.Add Array(placa, wsDatos.Range("D" & i).Text)
        ElseIf tipo = "02" Then
            salidas.Add Array(placa, wsDatos.Range("H" & i).Text)
        End If
    Next i

    ReDim usada(1 To entradas.Count)
    filaResultado = 2

    ' Emparejar cada salida con entrada m치s reciente anterior
    For i = 1 To salidas.Count
        Dim mejorIndex As Long: mejorIndex = -1
        Dim placaSalida As String: placaSalida = salidas(i)(0)
        Dim fechaSalidaTexto As String: fechaSalidaTexto = salidas(i)(1)

        ' Buscar entrada sin usar que sea anterior (en orden de aparici칩n)
        For j = 1 To entradas.Count
            If Not usada(j) Then
                If entradas(j)(0) = placaSalida Then
                    mejorIndex = j
                End If
            End If
        Next j

        ' Si encontr칩 una entrada para esta salida
        If mejorIndex <> -1 Then
            usada(mejorIndex) = True

            With wsParejas
                .Cells(filaResultado, 1).Value = placaSalida
                .Cells(filaResultado, 2).Value = entradas(mejorIndex)(1)
                .Cells(filaResultado, 3).Value = fechaSalidaTexto
                .Cells(filaResultado, 4).Value = "(No calculado)"
            End With

            filaResultado = filaResultado + 1
        End If
    Next i

    MsgBox "Emparejamiento completado. Las fechas se han copiado exactamente como se ven."

End Sub
