Sub EmparejarSecuencial()

    Dim wsDatos As Worksheet, wsParejas As Worksheet, wsSinPareja As Worksheet
    Dim ultimaFila As Long, i As Long, filaResultado As Long, filaSinPareja As Long
    Dim dictEventos As Object, eventos As Variant
    Dim clave As Variant
    Dim entradaPendiente As Date, tieneEntrada As Boolean
    
    Set wsDatos = ThisWorkbook.Sheets("Datos")
    
    ' Eliminar hojas anteriores si existen
    On Error Resume Next
    Application.DisplayAlerts = False
    ThisWorkbook.Sheets("Parejas").Delete
    ThisWorkbook.Sheets("SinPareja").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    Set wsParejas = ThisWorkbook.Sheets.Add: wsParejas.Name = "Parejas"
    Set wsSinPareja = ThisWorkbook.Sheets.Add: wsSinPareja.Name = "SinPareja"
    
    wsParejas.Range("A1:H1").Value = Array("Placa", "Día Entrada", "Mes Entrada", "Año Entrada", "Día Salida", "Mes Salida", "Año Salida", "Diferencia (minutos)")
    wsSinPareja.Range("A1:G1").Value = Array("Placa", "Tipo", "Día", "Mes", "Año", "Fecha", "Motivo")
    
    ultimaFila = wsDatos.Cells(wsDatos.Rows.Count, "B").End(xlUp).Row
    Set dictEventos = CreateObject("Scripting.Dictionary")
    
    For i = 2 To ultimaFila
        clave = Trim(wsDatos.Cells(i, "I").Value)
        If clave <> "" Then
            If Not dictEventos.exists(clave) Then
                dictEventos.Add clave, New Collection
            End If
            
            Dim tipoEvento As String, fechaEvento As Date
            tipoEvento = wsDatos.Cells(i, "B").Value
            
            If tipoEvento = "01" Then
                fechaEvento = wsDatos.Cells(i, "D").Value
            ElseIf tipoEvento = "02" Then
                fechaEvento = wsDatos.Cells(i, "H").Value
            Else
                GoTo Saltar
            End If
            
            dictEventos(clave).Add Array(tipoEvento, fechaEvento)
        End If
Saltar:
    Next i
    
    filaResultado = 2
    filaSinPareja = 2
    
    For Each clave In dictEventos.Keys
        eventos = dictEventos(clave)
        tieneEntrada = False
        
        MsgBox "Procesando placa: " & clave & vbCrLf & "Eventos registrados: " & eventos.Count
        
        For i = 1 To eventos.Count
            Dim tipo As String, fecha As Date
            tipo = eventos(i)(0)
            fecha = eventos(i)(1)
            
            MsgBox "Evento " & i & " de " & clave & vbCrLf & "Tipo: " & tipo & vbCrLf & "Fecha: " & fecha
            
            If tipo = "01" Then ' Entrada
                If tieneEntrada Then
                    MsgBox "Entrada previa sin salida para placa: " & clave & vbCrLf & "Fecha entrada: " & entradaPendiente
                    wsSinPareja.Cells(filaSinPareja, 1).Value = clave
                    wsSinPareja.Cells(filaSinPareja, 2).Value = "Entrada"
                    wsSinPareja.Cells(filaSinPareja, 3).Value = Day(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 4).Value = Month(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 5).Value = Year(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 6).Value = entradaPendiente
                    wsSinPareja.Cells(filaSinPareja, 7).Value = "Entrada sin salida"
                    filaSinPareja = filaSinPareja + 1
                End If
                entradaPendiente = fecha
                tieneEntrada = True
            
            ElseIf tipo = "02" Then ' Salida
                If tieneEntrada Then
                    MsgBox "Emparejando: " & clave & vbCrLf & "Entrada: " & entradaPendiente & vbCrLf & "Salida: " & fecha
                    wsParejas.Cells(filaResultado, 1).Value = clave
                    wsParejas.Cells(filaResultado, 2).Value = Day(entradaPendiente)
                    wsParejas.Cells(filaResultado, 3).Value = Month(entradaPendiente)
                    wsParejas.Cells(filaResultado, 4).Value = Year(entradaPendiente)
                    wsParejas.Cells(filaResultado, 5).Value = Day(fecha)
                    wsParejas.Cells(filaResultado, 6).Value = Month(fecha)
                    wsParejas.Cells(filaResultado, 7).Value = Year(fecha)
                    wsParejas.Cells(filaResultado, 8).Value = Round((fecha - entradaPendiente) * 1440, 2)
                    filaResultado = filaResultado + 1
                    tieneEntrada = False
                Else
                    MsgBox "Salida sin entrada previa para placa: " & clave & vbCrLf & "Fecha salida: " & fecha
                    wsSinPareja.Cells(filaSinPareja, 1).Value = clave
                    wsSinPareja.Cells(filaSinPareja, 2).Value = "Salida"
                    wsSinPareja.Cells(filaSinPareja, 3).Value = Day(fecha)
                    wsSinPareja.Cells(filaSinPareja, 4).Value = Month(fecha)
                    wsSinPareja.Cells(filaSinPareja, 5).Value = Year(fecha)
                    wsSinPareja.Cells(filaSinPareja, 6).Value = fecha
                    wsSinPareja.Cells(filaSinPareja, 7).Value = "Salida sin entrada"
                    filaSinPareja = filaSinPareja + 1
                End If
            End If
        Next i
        
        If tieneEntrada Then
            MsgBox "Entrada final sin salida para placa: " & clave & vbCrLf & "Fecha entrada: " & entradaPendiente
            wsSinPareja.Cells(filaSinPareja, 1).Value = clave
            wsSinPareja.Cells(filaSinPareja, 2).Value = "Entrada"
            wsSinPareja.Cells(filaSinPareja, 3).Value = Day(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 4).Value = Month(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 5).Value = Year(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 6).Value = entradaPendiente
            wsSinPareja.Cells(filaSinPareja, 7).Value = "Entrada sin salida final"
            filaSinPareja = filaSinPareja + 1
        End If
    Next clave
    
    MsgBox "Emparejamiento completado correctamente. Revisa las hojas 'Parejas' y 'SinPareja'."

End Sub
