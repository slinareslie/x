Sub EmparejarSecuencial()

    Dim wsDatos As Worksheet, wsParejas As Worksheet, wsSinPareja As Worksheet
    Dim ultimaFila As Long, i As Long, filaResultado As Long, filaSinPareja As Long
    Dim dictEventos As Object, eventos As Variant
    Dim clave As String, fila As Long
    Dim entradaPendiente As Date, tieneEntrada As Boolean
    
    Set wsDatos = ThisWorkbook.Sheets("Datos")
    
    ' Borrar hojas anteriores
    On Error Resume Next
    Application.DisplayAlerts = False
    ThisWorkbook.Sheets("Parejas").Delete
    ThisWorkbook.Sheets("SinPareja").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0

    ' Crear nuevas hojas
    Set wsParejas = ThisWorkbook.Sheets.Add: wsParejas.Name = "Parejas"
    Set wsSinPareja = ThisWorkbook.Sheets.Add: wsSinPareja.Name = "SinPareja"

    wsParejas.Range("A1:H1").Value = Array("Placa", "Día Entrada", "Mes Entrada", "Año Entrada", "Día Salida", "Mes Salida", "Año Salida", "Diferencia (minutos)")
    wsSinPareja.Range("A1:G1").Value = Array("Placa", "Tipo", "Día", "Mes", "Año", "Fecha", "Motivo")
    
    ultimaFila = wsDatos.Cells(wsDatos.Rows.Count, "B").End(xlUp).Row
    
    ' Agrupar eventos por placa
    Set dictEventos = CreateObject("Scripting.Dictionary")
    For i = 2 To ultimaFila
        clave = Trim(wsDatos.Cells(i, "I").Value)
        If clave <> "" Then
            If Not dictEventos.exists(clave) Then
                dictEventos.Add clave, New Collection
            End If
            Dim tipoEvento As String, fechaEvento As Date
            tipoEvento = wsDatos.Cells(i, "B").Value
            If tipoEvento = "01" Then
                fechaEvento = wsDatos.Cells(i, "D").Value
            ElseIf tipoEvento = "02" Then
                fechaEvento = wsDatos.Cells(i, "H").Value
            Else
                GoTo Saltar
            End If
            dictEventos(clave).Add Array(tipoEvento, fechaEvento)
        End If
Saltar:
    Next i

    filaResultado = 2
    filaSinPareja = 2

    ' Procesar eventos por placa
    For Each clave In dictEventos.keys
        eventos = dictEventos(clave)
        tieneEntrada = False
        For i = 1 To eventos.Count
            Dim tipo As String, fecha As Date
            tipo = eventos(i)(0)
            fecha = eventos(i)(1)

            If tipo = "01" Then ' Entrada
                If tieneEntrada Then
                    ' Ya había una entrada pendiente, esta no se puede emparejar
                    wsSinPareja.Cells(filaSinPareja, 1).Value = clave
                    wsSinPareja.Cells(filaSinPareja, 2).Value = "Entrada"
                    wsSinPareja.Cells(filaSinPareja, 3).Value = Day(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 4).Value = Month(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 5).Value = Year(entradaPendiente)
                    wsSinPareja.Cells(filaSinPareja, 6).Value = entradaPendiente
                    wsSinPareja.Cells(filaSinPareja, 7).Value = "Entrada sin salida"
                    filaSinPareja = filaSinPareja + 1
                End If
                entradaPendiente = fecha
                tieneEntrada = True
            ElseIf tipo = "02" Then ' Salida
                If tieneEntrada Then
                    ' Emparejar entrada con esta salida
                    wsParejas.Cells(filaResultado, 1).Value = clave
                    wsParejas.Cells(filaResultado, 2).Value = Day(entradaPendiente)
                    wsParejas.Cells(filaResultado, 3).Value = Month(entradaPendiente)
                    wsParejas.Cells(filaResultado, 4).Value = Year(entradaPendiente)
                    wsParejas.Cells(filaResultado, 5).Value = Day(fecha)
                    wsParejas.Cells(filaResultado, 6).Value = Month(fecha)
                    wsParejas.Cells(filaResultado, 7).Value = Year(fecha)
                    wsParejas.Cells(filaResultado, 8).Value = Round((fecha - entradaPendiente) * 1440, 2)
                    filaResultado = filaResultado + 1
                    tieneEntrada = False
                Else
                    ' Salida sin entrada previa
                    wsSinPareja.Cells(filaSinPareja, 1).Value = clave
                    wsSinPareja.Cells(filaSinPareja, 2).Value = "Salida"
                    wsSinPareja.Cells(filaSinPareja, 3).Value = Day(fecha)
                    wsSinPareja.Cells(filaSinPareja, 4).Value = Month(fecha)
                    wsSinPareja.Cells(filaSinPareja, 5).Value = Year(fecha)
                    wsSinPareja.Cells(filaSinPareja, 6).Value = fecha
                    wsSinPareja.Cells(filaSinPareja, 7).Value = "Salida sin entrada previa"
                    filaSinPareja = filaSinPareja + 1
                End If
            End If
        Next i

        ' Si queda una entrada sin salida al final
        If tieneEntrada Then
            wsSinPareja.Cells(filaSinPareja, 1).Value = clave
            wsSinPareja.Cells(filaSinPareja, 2).Value = "Entrada"
            wsSinPareja.Cells(filaSinPareja, 3).Value = Day(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 4).Value = Month(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 5).Value = Year(entradaPendiente)
            wsSinPareja.Cells(filaSinPareja, 6).Value = entradaPendiente
            wsSinPareja.Cells(filaSinPareja, 7).Value = "Entrada sin salida final"
            filaSinPareja = filaSinPareja + 1
        End If
    Next clave

    MsgBox "Emparejamiento completado. Revisar hojas 'Parejas' y 'SinPareja'."

End Sub
