$fecha = Get-Date -Format "dd-MM-yyyy"
$csvPath = "D:\Ordenar Scripts\Scripts probar\Transportista Descargar\consulta_resultado.csv"
$excelPath = "D:\Ordenar Scripts\Scripts probar\Transportista Descargar\consulta_resultado.xlsx"

# Iniciar Excel
$excelApp = New-Object -ComObject Excel.Application
$excelApp.Visible = $false
$excelApp.DisplayAlerts = $false

# Abrir archivo CSV como libro
$workbook = $excelApp.Workbooks.Open($csvPath)
$worksheet = $workbook.Sheets.Item(1)

# Detectar el rango usado
$usedRange = $worksheet.UsedRange
$rowCount = $usedRange.Rows.Count
$colCount = $usedRange.Columns.Count

# Definir el rango de la tabla (asumiendo encabezados en la primera fila)
$startCell = $worksheet.Cells.Item(1,1).Address()
$endCell = $worksheet.Cells.Item($rowCount, $colCount).Address()
$tableRange = "$startCell:$endCell"

# Insertar tabla
$excelListObject = $worksheet.ListObjects.Add(1, $worksheet.Range($tableRange), $null, 1)
$excelListObject.Name = "TablaSigad"

# Guardar como archivo Excel (.xlsx)
$workbook.SaveAs($excelPath, [Microsoft.Office.Interop.Excel.XlFileFormat]::xlOpenXMLWorkbook)
$workbook.Close($false)
$excelApp.Quit()

# Liberar recursos
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelListObject) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($worksheet) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) | Out-Null
[GC]::Collect()
[GC]::WaitForPendingFinalizers()
